# wxauto_http_api 架构说明

## 项目架构

本项目采用了清晰的模块化架构，将UI服务和API服务完全分离，避免了相互干扰。

### 主要模块

1. **main.py**：主入口点，负责解析命令行参数并决定启动UI还是API服务
2. **ui_service.py**：UI服务逻辑，负责启动和管理UI界面
3. **api_service.py**：API服务逻辑，负责启动和管理API服务
4. **app_ui.py**：UI界面的具体实现
5. **run.py**：API服务的具体实现
6. **app_mutex.py**：互斥锁机制，确保同一时间只有一个UI实例和一个API服务实例在运行
7. **fix_path.py**：路径修复模块，确保在打包环境中正确处理路径
8. **config_manager.py**：配置管理模块，负责加载和保存配置

### 启动流程

1. **启动UI服务**：
   ```
   python main.py --service ui
   ```
   或者双击 `start_ui.bat`

2. **启动API服务**：
   ```
   python main.py --service api
   ```
   或者双击 `start_api.bat`

3. **通过UI启动API服务**：
   在UI界面中点击"启动服务"按钮，会调用 `main.py --service api` 启动API服务

### 环境变量

项目使用以下环境变量来控制行为：

- **WXAUTO_SERVICE_TYPE**：服务类型，可以是 `ui` 或 `api`
- **WXAUTO_DEBUG**：是否启用调试模式，值为 `1` 时启用
- **WXAUTO_NO_MUTEX_CHECK**：是否禁用互斥锁检查，值为 `1` 时禁用

## 文件说明

### 核心文件

- **main.py**：主入口点，解析命令行参数并启动相应的服务
- **ui_service.py**：UI服务逻辑，负责启动和管理UI界面
- **api_service.py**：API服务逻辑，负责启动和管理API服务
- **app_ui.py**：UI界面的具体实现
- **run.py**：API服务的具体实现
- **app_mutex.py**：互斥锁机制，确保同一时间只有一个UI实例和一个API服务实例在运行
- **fix_path.py**：路径修复模块，确保在打包环境中正确处理路径
- **config_manager.py**：配置管理模块，负责加载和保存配置

### 辅助文件

- **start_ui.bat**：启动UI服务的批处理文件
- **start_api.bat**：启动API服务的批处理文件
- **build_app.py**：打包应用程序的脚本
- **create_icon.py**：创建应用程序图标的脚本
- **fix_dependencies.py**：检查和安装依赖项的脚本

### 配置文件

- **.env**：环境变量配置文件
- **data/api/config/app_config.json**：应用程序配置文件

## 打包说明

使用 `build_app.py` 脚本打包应用程序：

```
python build_app.py
```

打包选项：

- **--debug**：生成调试版本，包含控制台窗口
- **--onefile**：生成单文件版本，而不是文件夹

打包后的文件位于 `dist/wxauto_http_api` 目录下。

## 架构优势

1. **清晰的职责分离**：UI服务和API服务完全分离，职责明确
2. **避免相互干扰**：UI服务和API服务使用不同的启动脚本，避免了相互干扰
3. **更灵活的启动方式**：用户可以选择只启动UI、只启动API服务，或者通过UI启动API服务
4. **更好的错误处理**：每个服务都有详细的错误处理和日志记录，方便诊断问题
5. **避免重复启动**：通过互斥锁机制，确保同一时间只有一个UI实例和一个API服务实例在运行

## 常见问题

### 1. UI启动后无法启动API服务

可能原因：
- API服务已经在运行
- 端口被占用

解决方法：
- 检查是否已有API服务在运行，可以使用任务管理器查看
- 尝试修改配置文件中的端口号

### 2. API服务启动失败

可能原因：
- 依赖项缺失
- 端口被占用
- 路径问题

解决方法：
- 确保所有依赖项都已安装
- 检查端口是否被占用，可以尝试修改配置文件中的端口号
- 查看日志文件，了解详细错误信息

### 3. 打包后的应用程序无法启动

可能原因：
- 缺少必要的系统依赖
- 路径问题

解决方法：
- 确保系统安装了所有必要的依赖
- 尝试将应用程序移动到路径较短且不包含特殊字符的目录
- 查看日志文件，了解详细错误信息
